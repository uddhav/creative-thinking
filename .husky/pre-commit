#!/bin/sh

# Check if we're on the main branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" = "main" ]; then
  echo "Error: You are on the main branch. Please create a feature branch before committing."
  echo "You can create a new branch with: git checkout -b feat/your-feature-name"
  exit 1
fi

# Create temp directory for logs
TEMP_DIR=$(mktemp -d)
LINT_LOG="$TEMP_DIR/lint.log"
TEST_LOG="$TEMP_DIR/test.log"

# Run lint-staged to check only staged files (with 5 minute timeout)
echo "Running lint-staged..."
if ! timeout 300 npx lint-staged > "$LINT_LOG" 2>&1; then
  if [ $? -eq 124 ]; then
    echo "❌ Lint-staged timed out after 5 minutes"
  else
    echo "❌ Lint-staged failed. See output below:"
  fi
  cat "$LINT_LOG"
  rm -rf "$TEMP_DIR"
  exit 1
fi
echo "✅ Lint-staged passed"

# Run main tests (with 10 minute timeout)
echo "Running main tests..."
if ! timeout 600 npm test > "$TEST_LOG" 2>&1; then
  if [ $? -eq 124 ]; then
    echo "❌ Main tests timed out after 10 minutes"
  else
    echo "❌ Main tests failed. See output below:"
  fi
  cat "$TEST_LOG"
  rm -rf "$TEMP_DIR"
  exit 1
fi
echo "✅ Main tests passed"

# Run cloudflare deployment tests if the directory exists
if [ -d "cloudflare-deployment" ]; then
  echo "Running cloudflare deployment tests..."
  CLOUDFLARE_TEST_LOG="$TEMP_DIR/cloudflare-test.log"
  
  # Change to cloudflare-deployment directory and run tests
  if ! (cd cloudflare-deployment && timeout 300 npm test > "$CLOUDFLARE_TEST_LOG" 2>&1); then
    if [ $? -eq 124 ]; then
      echo "❌ Cloudflare tests timed out after 5 minutes"
    else
      echo "❌ Cloudflare tests failed. See output below:"
    fi
    cat "$CLOUDFLARE_TEST_LOG"
    rm -rf "$TEMP_DIR"
    exit 1
  fi
  echo "✅ Cloudflare deployment tests passed"
fi

# Clean up temp files
rm -rf "$TEMP_DIR"
